{% extends "base.html" %}

{% block title %}Dashboard - Product Analytics{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="text-white text-center mb-4">
            <i class="fas fa-chart-pie me-3"></i>
            Product Analytics Dashboard
        </h1>
        <p class="text-white text-center opacity-75">
            Comprehensive overview of your product inventory and performance metrics
        </p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-5">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_products }}</div>
            <div class="stat-label">Total Products</div>
            <i class="fas fa-box fa-2x mt-3 opacity-75"></i>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_cost }}</div>
            <div class="stat-label">Total Value</div>
            <i class="fas fa-dollar-sign fa-2x mt-3 opacity-75"></i>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card">
            <div class="stat-number">{{ stats.avg_cost }}</div>
            <div class="stat-label">Average Cost</div>
            <i class="fas fa-calculator fa-2x mt-3 opacity-75"></i>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card">
            <div class="stat-number">{{ stats.avg_weight }}</div>
            <div class="stat-label">Average Weight</div>
            <i class="fas fa-weight-hanging fa-2x mt-3 opacity-75"></i>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-5">
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Products by Category
                </h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Category Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="pieChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="/products" class="btn btn-primary w-100">
                            <i class="fas fa-list me-2"></i>
                            View All Products
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="refreshStats()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh Data
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-success w-100" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>
                            Export Data
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-info w-100" onclick="showSearch()">
                            <i class="fas fa-search me-2"></i>
                            Search Products
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>
                    Search Products
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control search-box" id="searchInput" 
                           placeholder="Search by SKU, product name, type, or details...">
                    <button class="btn btn-primary" type="button" onclick="performSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="searchResults" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chart.js configuration
const ctx = document.getElementById('categoryChart').getContext('2d');
const pieCtx = document.getElementById('pieChart').getContext('2d');

// Bar chart for categories
const categoryChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ stats.type_counts.keys() | list | tojson }},
        datasets: [{
            label: 'Number of Products',
            data: {{ stats.type_counts.values() | list | tojson }},
            backgroundColor: [
                'rgba(99, 102, 241, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(239, 68, 68, 0.8)',
                'rgba(6, 182, 212, 0.8)',
                'rgba(168, 85, 247, 0.8)',
                'rgba(34, 197, 94, 0.8)'
            ],
            borderColor: [
                'rgba(99, 102, 241, 1)',
                'rgba(139, 92, 246, 1)',
                'rgba(16, 185, 129, 1)',
                'rgba(245, 158, 11, 1)',
                'rgba(239, 68, 68, 1)',
                'rgba(6, 182, 212, 1)',
                'rgba(168, 85, 247, 1)',
                'rgba(34, 197, 94, 1)'
            ],
            borderWidth: 2,
            borderRadius: 8
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Pie chart for category distribution
const pieChart = new Chart(pieCtx, {
    type: 'doughnut',
    data: {
        labels: {{ stats.type_counts.keys() | list | tojson }},
        datasets: [{
            data: {{ stats.type_counts.values() | list | tojson }},
            backgroundColor: [
                'rgba(99, 102, 241, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(239, 68, 68, 0.8)',
                'rgba(6, 182, 212, 0.8)',
                'rgba(168, 85, 247, 0.8)',
                'rgba(34, 197, 94, 0.8)'
            ],
            borderColor: 'rgba(255, 255, 255, 0.8)',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            }
        }
    }
});

// Functions
function refreshStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            location.reload();
        })
        .catch(error => console.error('Error refreshing stats:', error));
}

function exportData() {
    fetch('/api/products?per_page=10000')
        .then(response => response.json())
        .then(data => {
            const csvContent = convertToCSV(data.products);
            downloadCSV(csvContent, 'products_export.csv');
        })
        .catch(error => console.error('Error exporting data:', error));
}

function convertToCSV(products) {
    const headers = ['Item #', 'SKU', 'Product', 'Type', 'Cost', 'Weight (kg)', 'Dimensions', 'Details'];
    const csvRows = [headers.join(',')];
    
    products.forEach(product => {
        const row = [
            product['item_#'] || '',
            product.sku || '',
            product.product || '',
            product.type || '',
            product.cost || '',
            product.weight_(kg) || '',
            product.dimensions || '',
            `"${(product.details || '').replace(/"/g, '""')}"`
        ];
        csvRows.push(row.join(','));
    });
    
    return csvRows.join('\n');
}

function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function showSearch() {
    const modal = new bootstrap.Modal(document.getElementById('searchModal'));
    modal.show();
}

function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) return;
    
    fetch(`/api/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            displaySearchResults(data);
        })
        .catch(error => console.error('Error searching:', error));
}

function displaySearchResults(products) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (products.length === 0) {
        resultsDiv.innerHTML = '<div class="alert alert-info">No products found matching your search.</div>';
        return;
    }
    
    let html = `<div class="alert alert-success">Found ${products.length} products</div>`;
    html += '<div class="table-responsive"><table class="table table-hover">';
    html += '<thead><tr><th>Item #</th><th>SKU</th><th>Product</th><th>Type</th><th>Cost</th><th>Weight</th></tr></thead><tbody>';
    
    products.forEach(product => {
        html += `<tr>
            <td><strong>${product['item_#'] || ''}</strong></td>
            <td><strong>${product.sku || ''}</strong></td>
            <td>${product.product || ''}</td>
            <td><span class="badge bg-primary">${product.type || ''}</span></td>
            <td>${product.cost || ''}</td>
            <td>${product.weight_(kg) || ''} kg</td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    resultsDiv.innerHTML = html;
}

// Search on Enter key
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        performSearch();
    }
});
</script>
{% endblock %}
