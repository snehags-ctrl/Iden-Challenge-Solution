{% extends "base.html" %}

{% block title %}Products - Inventory Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="text-white text-center mb-4">
            <i class="fas fa-boxes me-3"></i>
            Product Inventory
        </h1>
        <p class="text-white text-center opacity-75">
            Complete list of all products with detailed information
        </p>
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4 mb-3">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control search-box" id="searchInput" 
                                   placeholder="Search products...">
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <select class="form-select" id="typeFilter">
                            <option value="">All Types</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Garden">Garden</option>
                            <option value="Toys">Toys</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Books">Books</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Home & Kitchen">Home & Kitchen</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <select class="form-select" id="sortBy">
                            <option value="sku">Sort by SKU</option>
                            <option value="product">Sort by Product Name</option>
                            <option value="cost">Sort by Cost</option>
                            <option value="weight">Sort by Weight</option>
                            <option value="type">Sort by Type</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter me-2"></i>Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Products Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>
                    Products List
                </h5>
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3" id="productCount">Loading...</span>
                    <button class="btn btn-outline-success btn-sm" onclick="exportFilteredData()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="productsTable">
                        <thead>
                            <tr>
                                <th>Item #</th>
                                <th>SKU</th>
                                <th>Product</th>
                                <th>Type</th>
                                <th>Cost</th>
                                <th>Weight</th>
                                <th>Dimensions</th>
                                <th>Details</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="9" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Products pagination" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Product Detail Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>
                    Product Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productModalBody">
                <!-- Product details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentProducts = [];
let filteredProducts = [];
let currentPage = 1;
const productsPerPage = 20;

// Load products on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
});

function loadProducts() {
    fetch('/api/products?per_page=10000')
        .then(response => response.json())
        .then(data => {
            currentProducts = data.products;
            filteredProducts = [...currentProducts];
            updateProductCount();
            displayProducts();
            generatePagination();
        })
        .catch(error => {
            console.error('Error loading products:', error);
            document.getElementById('productsTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading products</td></tr>';
        });
}

function applyFilters() {
    const searchQuery = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const sortBy = document.getElementById('sortBy').value;
    
    filteredProducts = currentProducts.filter(product => {
        const matchesSearch = !searchQuery || 
            product.sku.toLowerCase().includes(searchQuery) ||
            product.product.toLowerCase().includes(searchQuery) ||
            product.type.toLowerCase().includes(searchQuery) ||
            product.details.toLowerCase().includes(searchQuery);
        
        const matchesType = !typeFilter || product.type === typeFilter;
        
        return matchesSearch && matchesType;
    });
    
    // Sort products
    filteredProducts.sort((a, b) => {
        switch(sortBy) {
            case 'sku':
                return a.sku.localeCompare(b.sku);
            case 'product':
                return a.product.localeCompare(b.product);
            case 'cost':
                return parseFloat(a.cost.replace('$', '')) - parseFloat(b.cost.replace('$', ''));
            case 'weight':
                return parseFloat(a.weight_(kg)) - parseFloat(b.weight_(kg));
            case 'type':
                return a.type.localeCompare(b.type);
            default:
                return 0;
        }
    });
    
    currentPage = 1;
    updateProductCount();
    displayProducts();
    generatePagination();
}

function displayProducts() {
    const startIndex = (currentPage - 1) * productsPerPage;
    const endIndex = startIndex + productsPerPage;
    const pageProducts = filteredProducts.slice(startIndex, endIndex);
    
    const tbody = document.getElementById('productsTableBody');
    
    if (pageProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No products found</td></tr>';
        return;
    }
    
    let html = '';
    pageProducts.forEach(product => {
        html += `
            <tr>
                <td><strong>${product['item_#'] || ''}</strong></td>
                <td><strong>${product.sku || ''}</strong></td>
                <td>${product.product || ''}</td>
                <td><span class="badge bg-primary">${product.type || ''}</span></td>
                <td><span class="text-success fw-bold">${product.cost || ''}</span></td>
                <td>${product.weight_(kg) || ''} kg</td>
                <td><small class="text-muted">${product.dimensions || ''}</small></td>
                <td>
                    <div class="text-truncate" style="max-width: 200px;" title="${product.details || ''}">
                        ${product.details || ''}
                    </div>
                </td>
                <td>
                    <button class="btn btn-outline-info btn-sm" onclick="showProductDetails('${product.sku}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function generatePagination() {
    const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    // Next button
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;
    
    pagination.innerHTML = html;
}

function changePage(page) {
    if (page < 1 || page > Math.ceil(filteredProducts.length / productsPerPage)) return;
    currentPage = page;
    displayProducts();
    generatePagination();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateProductCount() {
    const countElement = document.getElementById('productCount');
    countElement.textContent = `Showing ${filteredProducts.length} of ${currentProducts.length} products`;
}

function showProductDetails(sku) {
    const product = currentProducts.find(p => p.sku === sku);
    if (!product) return;
    
    const modalBody = document.getElementById('productModalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-muted">SKU</h6>
                <p class="fw-bold">${product.sku || 'N/A'}</p>
                
                <h6 class="text-muted">Product Name</h6>
                <p class="fw-bold">${product.product || 'N/A'}</p>
                
                <h6 class="text-muted">Category</h6>
                <p><span class="badge bg-primary">${product.type || 'N/A'}</span></p>
                
                <h6 class="text-muted">Cost</h6>
                <p class="text-success fw-bold fs-5">${product.cost || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted">Weight</h6>
                <p>${product.weight_(kg) || 'N/A'} kg</p>
                
                <h6 class="text-muted">Dimensions</h6>
                <p>${product.dimensions || 'N/A'}</p>
                
                <h6 class="text-muted">Item Number</h6>
                <p>${product['item_#'] || 'N/A'}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="text-muted">Description</h6>
                <p class="text-muted">${product.details || 'No description available'}</p>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
}

function exportFilteredData() {
    const csvContent = convertToCSV(filteredProducts);
    downloadCSV(csvContent, 'filtered_products.csv');
}

function convertToCSV(products) {
    const headers = ['Item #', 'SKU', 'Product', 'Type', 'Cost', 'Weight (kg)', 'Dimensions', 'Details'];
    const csvRows = [headers.join(',')];
    
    products.forEach(product => {
        const row = [
            product['item_#'] || '',
            product.sku || '',
            product.product || '',
            product.type || '',
            product.cost || '',
            product.weight_(kg) || '',
            product.dimensions || '',
            `"${(product.details || '').replace(/"/g, '""')}"`
        ];
        csvRows.push(row.join(','));
    });
    
    return csvRows.join('\n');
}

function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Search on Enter key
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        applyFilters();
    }
});

// Auto-filter on type change
document.getElementById('typeFilter').addEventListener('change', function() {
    applyFilters();
});

// Auto-filter on sort change
document.getElementById('sortBy').addEventListener('change', function() {
    applyFilters();
});
</script>
{% endblock %}
